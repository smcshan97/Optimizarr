<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizarr</title>
    <link rel="stylesheet" href="/static/css/theme.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Override Tailwind's body defaults with our theme */
        body { background: var(--bg-base) !important; color: var(--text-primary) !important; font-family: var(--font-sans) !important; }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay hidden" id="mobileOverlay" onclick="toggleSidebar()"></div>

    <div class="app-layout">
        <!-- SIDEBAR NAVIGATION (Sonarr/Radarr-style) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <h1>Optimizarr</h1>
                <p>Media Optimization</p>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">Media</div>
                <a class="nav-item active" onclick="switchTab('queue')" data-tab="queue">
                    <span class="nav-icon">üìã</span>
                    <span class="nav-label">Queue</span>
                    <span class="nav-badge" id="navQueueCount">0</span>
                </a>
                <a class="nav-item" onclick="switchTab('profiles')" data-tab="profiles">
                    <span class="nav-icon">üéõÔ∏è</span>
                    <span class="nav-label">Profiles</span>
                </a>
                <a class="nav-item" onclick="switchTab('scan-roots')" data-tab="scan-roots">
                    <span class="nav-icon">üìÇ</span>
                    <span class="nav-label">Libraries</span>
                </a>
                <a class="nav-item" onclick="switchTab('watches')" data-tab="watches">
                    <span class="nav-icon">üëÅÔ∏è</span>
                    <span class="nav-label">Folder Watches</span>
                </a>
                <div class="nav-section">Insights</div>
                <a class="nav-item" onclick="switchTab('statistics')" data-tab="statistics">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-label">Statistics</span>
                </a>
                <a class="nav-item" onclick="switchTab('logs')" data-tab="logs">
                    <span class="nav-icon">üìÑ</span>
                    <span class="nav-label">Logs</span>
                </a>
                <div class="nav-section">System</div>
                <a class="nav-item" onclick="switchTab('schedule')" data-tab="schedule">
                    <span class="nav-icon">üïê</span>
                    <span class="nav-label">Schedule</span>
                </a>
                <a class="nav-item" onclick="switchTab('connections')" data-tab="connections">
                    <span class="nav-icon">üîó</span>
                    <span class="nav-label">Connections</span>
                </a>
                <a class="nav-item" onclick="switchTab('settings')" data-tab="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-label">Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <span id="sidebarUser">admin</span>
                <button class="btn btn-xs btn-danger" onclick="logout()">Logout</button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <button class="mobile-menu-btn btn btn-secondary btn-icon mb-3" onclick="toggleSidebar()">‚ò∞</button>

            <!-- Dashboard Stats -->
            <div class="stat-grid" id="dashboardStats">
                <div class="stat-card"><div class="stat-label">Space Saved</div><div class="stat-value green" id="spaceSaved">0 GB</div></div>
                <div class="stat-card"><div class="stat-label">Files Processed</div><div class="stat-value blue" id="filesProcessed">0</div></div>
                <div class="stat-card"><div class="stat-label">Queue Pending</div><div class="stat-value yellow" id="queuePending">0</div></div>
                <div class="stat-card"><div class="stat-label">Active Jobs</div><div class="stat-value purple" id="activeJobs">0</div></div>
            </div>

            <!-- Resource Monitoring -->
            <div class="resource-grid" id="resourceMonitor">
                <div class="resource-card">
                    <div class="resource-label">CPU Usage</div>
                    <div class="flex items-center gap-2">
                        <div class="resource-value" id="cpuUsage" style="color:var(--accent)">0%</div>
                        <span class="text-xs text-muted" id="cpuStatus"></span>
                    </div>
                    <div class="resource-bar-track"><div class="resource-bar-fill cyan" id="cpuBar" style="width:0%"></div></div>
                </div>
                <div class="resource-card">
                    <div class="resource-label">Memory Usage</div>
                    <div class="flex items-center gap-2">
                        <div class="resource-value" id="memoryUsage" style="color:var(--processing)">0%</div>
                        <span class="text-xs text-muted" id="memoryStatus"></span>
                    </div>
                    <div class="resource-bar-track"><div class="resource-bar-fill purple" id="memoryBar" style="width:0%"></div></div>
                </div>
                <div class="resource-card">
                    <div class="resource-label">GPU Usage</div>
                    <div class="flex items-center gap-2">
                        <div class="resource-value" id="gpuUsage" style="color:#e67e22">N/A</div>
                        <span class="text-xs text-muted" id="gpuStatus"></span>
                    </div>
                    <div class="resource-bar-track"><div class="resource-bar-fill orange" id="gpuBar" style="width:0%"></div></div>
                </div>
            </div>

            <!-- QUEUE TAB -->
            <div class="tab-panel active" id="tab-queue">
                <div class="page-toolbar">
                    <div><h2 class="page-title">Queue</h2><p class="page-subtitle">Encoding jobs and progress</p></div>
                    <div class="toolbar-actions">
                        <label class="form-checkbox"><input type="checkbox" id="autoRefreshQueue" checked onchange="toggleAutoRefresh()"><span class="text-xs">Auto-refresh</span></label>
                        <button class="btn btn-primary btn-sm" id="scanAllBtn" onclick="scanAllRoots()"><span id="scanAllIcon">üîç</span> <span id="scanAllText">Scan All</span></button>
                        <button class="btn btn-success btn-sm" onclick="startEncoding()">‚ñ∂ Start</button>
                        <button class="btn btn-danger btn-sm" onclick="stopEncoding()">‚èπ Stop</button>
                    </div>
                </div>
                <div class="card card-compact mb-3">
                    <div class="flex items-center gap-3" style="flex-wrap:wrap">
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-muted">Status:</label>
                            <select id="queueFilterStatus" class="form-select" style="width:auto;padding:5px 30px 5px 10px" onchange="loadQueue()">
                                <option value="">All</option><option value="pending">Pending</option><option value="processing">Processing</option><option value="completed">Completed</option><option value="failed">Failed</option><option value="paused">Paused</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-muted">Search:</label>
                            <input type="text" id="queueSearchInput" class="form-input" style="width:200px;padding:5px 10px" placeholder="Filter by filename..." oninput="debouncedFilterQueue()">
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-muted">Priority:</label>
                            <select id="queueSortBy" class="form-select" style="width:auto;padding:5px 30px 5px 10px">
                                <option value="default">Default</option><option value="file_size">File Size</option><option value="estimated_savings">Est. Savings</option><option value="filename">Filename</option>
                            </select>
                            <button class="btn btn-secondary btn-xs" onclick="applyQueuePriority()">Apply</button>
                        </div>
                        <div style="margin-left:auto" class="flex items-center gap-2">
                            <label class="form-checkbox"><input type="checkbox" id="selectAllQueue" onchange="toggleSelectAll()"><span class="text-xs">Select All</span></label>
                            <button class="btn btn-secondary btn-xs" onclick="bulkAction('delete')">üóëÔ∏è Delete</button>
                            <button class="btn btn-secondary btn-xs" onclick="bulkAction('retry')">üîÑ Retry</button>
                            <button class="btn btn-secondary btn-xs" onclick="bulkAction('pause')">‚è∏ Pause</button>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="queueTable">
                        <thead><tr>
                            <th style="width:32px"><input type="checkbox" id="queueHeaderCheck" onchange="toggleSelectAll()"></th>
                            <th class="sortable" onclick="sortQueue('filename')">File <span class="sort-arrow">‚Üï</span></th>
                            <th class="sortable" onclick="sortQueue('status')">Status <span class="sort-arrow">‚Üï</span></th>
                            <th class="sortable" onclick="sortQueue('profile')">Profile <span class="sort-arrow">‚Üï</span></th>
                            <th class="sortable" onclick="sortQueue('size')">Size <span class="sort-arrow">‚Üï</span></th>
                            <th class="sortable" onclick="sortQueue('savings')">Savings <span class="sort-arrow">‚Üï</span></th>
                            <th>Progress</th>
                            <th style="width:120px">Actions</th>
                        </tr></thead>
                        <tbody id="queueBody"><tr><td colspan="8" class="text-center text-muted" style="padding:40px">Loading queue...</td></tr></tbody>
                    </table>
                </div>
                <!-- Bulk actions floating bar -->
                <div id="bulkActionsBar" class="hidden" style="position:sticky;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;gap:12px;z-index:10">
                    <span class="text-sm"><strong id="bulkSelectedCount">0</strong> items selected</span>
                    <button class="btn btn-secondary btn-xs" onclick="bulkAction('delete')">üóëÔ∏è Delete</button>
                    <button class="btn btn-secondary btn-xs" onclick="bulkAction('retry')">üîÑ Retry</button>
                    <button class="btn btn-secondary btn-xs" onclick="bulkAction('pause')">‚è∏ Pause</button>
                    <button class="btn btn-secondary btn-xs" onclick="bulkAction('resume')">‚ñ∂ Resume</button>
                    <button class="btn btn-xs" style="margin-left:auto;color:var(--text-muted)" onclick="clearSelection()">‚úï Clear</button>
                </div>
            </div>

            <!-- PROFILES TAB -->
            <div class="tab-panel" id="tab-profiles">
                <div class="page-toolbar">
                    <div><h2 class="page-title">Encoding Profiles</h2><p class="page-subtitle">Configure video encoding settings</p></div>
                    <div class="toolbar-actions">
                        <button class="btn btn-secondary btn-sm" onclick="showCodecGuide()">üìñ Codec Guide</button>
                        <button class="btn btn-secondary btn-sm" onclick="exportProfiles()">‚¨áÔ∏è Export</button>
                        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('importProfileFile').click()">‚¨ÜÔ∏è Import</button>
                        <input type="file" id="importProfileFile" accept=".json" class="hidden" onchange="importProfiles(event)">
                        <button class="btn btn-primary btn-sm" onclick="showCreateProfileForm()">+ New Profile</button>
                    </div>
                </div>
                <div id="profilesList"><div class="empty-state"><div class="empty-icon">üéõÔ∏è</div><div class="empty-text">Loading profiles...</div></div></div>
            </div>

            <!-- LIBRARIES TAB -->
            <div class="tab-panel" id="tab-scan-roots">
                <div class="page-toolbar">
                    <div><h2 class="page-title">Libraries</h2><p class="page-subtitle">Scan root directories for media</p></div>
                    <div class="toolbar-actions"><button class="btn btn-primary btn-sm" onclick="showCreateRootForm()">+ Add Library</button></div>
                </div>
                <div id="scanRootsList"><div class="empty-state"><div class="empty-icon">üìÇ</div><div class="empty-text">Loading libraries...</div></div></div>
            </div>

            <!-- WATCHES TAB -->
            <div class="tab-panel" id="tab-watches">
                <div class="page-toolbar">
                    <div><h2 class="page-title">Folder Watches</h2><p class="page-subtitle">Automatic file monitoring</p></div>
                    <div class="toolbar-actions">
                        <div id="watcherStatus" class="text-xs text-muted"></div>
                        <button class="btn btn-secondary btn-sm" onclick="forceWatchCheck()">üîÑ Check Now</button>
                        <button class="btn btn-primary btn-sm" onclick="showCreateWatchForm()">+ Add Watch</button>
                    </div>
                </div>
                <div id="watchesList"><div class="empty-state"><div class="empty-icon">üëÅÔ∏è</div><div class="empty-text">Loading watches...</div></div></div>
            </div>

            <!-- STATISTICS TAB -->
            <div class="tab-panel" id="tab-statistics">
                <div class="page-toolbar">
                    <div><h2 class="page-title">Statistics</h2><p class="page-subtitle">Encoding performance and savings</p></div>
                    <div class="toolbar-actions">
                        <select id="statsDays" class="form-select" style="width:auto;padding:5px 30px 5px 10px" onchange="loadStatistics()">
                            <option value="7">7 Days</option><option value="30" selected>30 Days</option><option value="90">90 Days</option><option value="365">Year</option>
                        </select>
                        <label class="form-checkbox"><input type="checkbox" id="statsHideSensitive" onchange="loadStatistics()"><span class="text-xs">Hide sensitive paths</span></label>
                    </div>
                </div>
                <div class="stat-grid mb-4" id="statsCards" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr))">
                    <div class="stat-card"><div class="stat-label">Total Encoded</div><div class="stat-value cyan" id="statTotalFiles">0</div></div>
                    <div class="stat-card"><div class="stat-label">Original Size</div><div class="stat-value blue" id="statOriginalSize">0 GB</div></div>
                    <div class="stat-card"><div class="stat-label">New Size</div><div class="stat-value purple" id="statNewSize">0 GB</div></div>
                    <div class="stat-card"><div class="stat-label">Space Saved</div><div class="stat-value green" id="statSaved">0 GB</div></div>
                    <div class="stat-card"><div class="stat-label">Avg. Reduction</div><div class="stat-value yellow" id="statAvgPct">0%</div></div>
                    <div class="stat-card"><div class="stat-label">Avg. Encode Time</div><div class="stat-value purple" id="statAvgTime">‚Äî</div></div>
                </div>
                <div class="grid grid-2 gap-4">
                    <div class="card"><div class="card-title mb-3">Daily Activity</div><div id="dailyChart" style="min-height:200px" class="text-muted text-sm text-center">No data</div></div>
                    <div class="card"><div class="card-title mb-3">Codec Distribution</div><div id="codecChart" style="min-height:200px" class="text-muted text-sm text-center">No data</div></div>
                </div>
                <div class="grid grid-2 gap-4 mt-4">
                    <div class="card"><div class="card-title mb-3">Codec Breakdown</div><div id="codecBreakdown" class="space-y-3 text-muted text-sm">No data</div></div>
                    <div class="card"><div class="card-title mb-3">Recent History</div><div id="recentHistory" class="space-y-2 text-muted text-sm" style="max-height:400px;overflow-y:auto">No encoding history yet</div></div>
                </div>
                <!-- Upscaler & Reprobe Status -->
                <div class="grid grid-2 gap-4 mt-4">
                    <div class="card"><div class="card-title mb-3">AI Upscaler Status</div><div id="upscalerStatus" class="text-sm text-muted">Checking...</div></div>
                    <div class="card">
                        <div class="card-title mb-3">File Reprobe</div>
                        <p class="text-xs text-muted mb-3">Re-scan all completed files to update codec/size metadata</p>
                        <button id="reprobeBtn" class="btn btn-secondary btn-sm" onclick="reprobeQueue()"><span id="reproBtnIcon">üîÑ</span> <span id="reproBtnText">Reprobe All</span></button>
                    </div>
                </div>
            </div>

            <!-- LOGS TAB -->
            <div class="tab-panel" id="tab-logs">
                <div class="page-toolbar">
                    <div><h2 class="page-title">Logs</h2><p class="page-subtitle">System and encoding logs</p></div>
                    <div class="toolbar-actions">
                        <select id="logType" class="form-select" style="width:auto;padding:5px 30px 5px 10px" onchange="loadLogs()">
                            <option value="app">Application</option><option value="handbrake">HandBrake</option><option value="error">Errors</option>
                        </select>
                        <select id="logLevel" class="form-select" style="width:auto;padding:5px 30px 5px 10px" onchange="loadLogs()">
                            <option value="all">All Levels</option><option value="DEBUG">Debug</option><option value="INFO">Info</option><option value="WARNING">Warning</option><option value="ERROR">Error</option>
                        </select>
                        <select id="logLines" class="form-select" style="width:auto;padding:5px 30px 5px 10px" onchange="loadLogs()">
                            <option value="100">100</option><option value="250">250</option><option value="500" selected>500</option><option value="1000">1000</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="loadLogs()">üîÑ Refresh</button>
                        <button class="btn btn-danger btn-sm" onclick="clearLogs()">üóëÔ∏è Clear</button>
                    </div>
                </div>
                <div class="text-xs text-muted mb-2" id="logStats"></div>
                <div class="log-viewer" id="logOutput"><span class="text-muted">Select a log type and click Refresh...</span></div>
            </div>

            <!-- SCHEDULE TAB -->
            <div class="tab-panel" id="tab-schedule">
                <div class="page-toolbar">
                    <div><h2 class="page-title">Schedule</h2><p class="page-subtitle">Configure encoding time windows</p></div>
                    <div class="toolbar-actions"><button class="btn btn-primary btn-sm" onclick="saveSchedule()">üíæ Save Schedule</button></div>
                </div>
                <div class="card">
                    <div class="grid grid-2 gap-4">
                        <div class="form-group"><label class="form-label">Start Time</label><input type="time" id="scheduleStart" class="form-input" value="22:00"></div>
                        <div class="form-group"><label class="form-label">End Time</label><input type="time" id="scheduleEnd" class="form-input" value="06:00"></div>
                    </div>
                    <div class="form-group mt-3">
                        <label class="form-label">Active Days</label>
                        <div class="flex gap-2" style="flex-wrap:wrap" id="scheduleDays">
                            <label class="form-checkbox"><input type="checkbox" value="mon" checked> Mon</label>
                            <label class="form-checkbox"><input type="checkbox" value="tue" checked> Tue</label>
                            <label class="form-checkbox"><input type="checkbox" value="wed" checked> Wed</label>
                            <label class="form-checkbox"><input type="checkbox" value="thu" checked> Thu</label>
                            <label class="form-checkbox"><input type="checkbox" value="fri" checked> Fri</label>
                            <label class="form-checkbox"><input type="checkbox" value="sat" checked> Sat</label>
                            <label class="form-checkbox"><input type="checkbox" value="sun" checked> Sun</label>
                        </div>
                    </div>
                    <label class="form-checkbox mt-3"><input type="checkbox" id="scheduleEnabled"><span>Enable scheduled encoding</span></label>
                    <label class="form-checkbox mt-2"><input type="checkbox" id="scheduleActiveHours"><span>Respect Windows Active Hours</span></label>
                </div>
            </div>

            <!-- CONNECTIONS TAB -->
            <div class="tab-panel" id="tab-connections">
                <div class="page-toolbar">
                    <div><h2 class="page-title">External Connections</h2><p class="page-subtitle">Sonarr, Radarr, Stash integrations</p></div>
                    <div class="toolbar-actions"><button class="btn btn-primary btn-sm" onclick="showCreateConnectionForm()">+ Add Connection</button></div>
                </div>
                <div id="connectionsList"><div class="empty-state"><div class="empty-icon">üîó</div><div class="empty-text">Loading connections...</div></div></div>
            </div>

            <!-- SETTINGS TAB -->
            <div class="tab-panel" id="tab-settings">
                <div class="page-toolbar"><div><h2 class="page-title">Settings</h2><p class="page-subtitle">Application configuration</p></div></div>
                <div class="grid grid-2 gap-4">
                    <div class="card">
                        <div class="card-title mb-3">Account</div>
                        <div class="form-group"><label class="form-label">Username</label><input type="text" id="accountUsername" class="form-input" readonly></div>
                        <div class="form-group"><label class="form-label">Role</label><input type="text" id="accountRole" class="form-input" readonly></div>
                        <div class="divider"></div>
                        <div class="card-title mb-3">Change Password</div>
                        <div class="form-group"><label class="form-label">Current Password</label><input type="password" id="currentPassword" class="form-input"></div>
                        <div class="form-group"><label class="form-label">New Password</label><input type="password" id="newPassword" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Confirm Password</label><input type="password" id="confirmPassword" class="form-input"></div>
                        <button class="btn btn-primary btn-sm" onclick="changePassword()">Update Password</button>
                    </div>
                    <div class="card">
                        <div class="card-title mb-3">System</div>
                        <label class="form-checkbox"><input type="checkbox" id="settingsThrottle" checked><span>Enable automatic resource throttling</span></label>
                        <div class="divider"></div>
                        <div class="card-title mb-3">Resource Thresholds</div>
                        <div class="grid grid-2 gap-3">
                            <div class="form-group"><label class="form-label">CPU %</label><input type="number" id="cpuThreshold" class="form-input" value="90" min="10" max="100"></div>
                            <div class="form-group"><label class="form-label">Memory %</label><input type="number" id="memoryThreshold" class="form-input" value="85" min="10" max="100"></div>
                            <div class="form-group"><label class="form-label">GPU %</label><input type="number" id="gpuThreshold" class="form-input" value="90" min="10" max="100"></div>
                            <div class="form-group"><label class="form-label">Nice Level</label><input type="number" id="niceLevel" class="form-input" value="10" min="0" max="19"></div>
                        </div>
                        <button class="btn btn-primary btn-sm mt-2" onclick="saveResourceSettings()">Save Thresholds</button>
                        <div class="divider"></div>
                        <div class="card-title mb-3">Data Management</div>
                        <div class="flex gap-2">
                            <button class="btn btn-secondary btn-sm" onclick="downloadBackup()">‚¨áÔ∏è Backup</button>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('restoreFile').click()">‚¨ÜÔ∏è Restore</button>
                            <input type="file" id="restoreFile" accept=".db,.sqlite" class="hidden" onchange="restoreBackup(event)">
                        </div>
                        <div id="restoreFileName" class="text-xs text-muted mt-2 hidden"></div>
                        <div id="restoreStatus" class="text-xs mt-1 hidden"></div>
                        <div class="divider"></div>
                        <div class="card-title mb-3">Health Check</div>
                        <div id="healthStatus" class="text-sm text-muted">Click to check system health</div>
                        <button class="btn btn-secondary btn-sm mt-2" onclick="loadHealth()">ü©∫ Run Health Check</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->

    <!-- Profile Modal -->
    <div class="modal-backdrop hidden" id="profileModal">
        <div class="modal-panel" style="max-width:720px">
            <div class="modal-header">
                <h3 class="modal-title" id="profileModalTitle">New Profile</h3>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profileForm" onsubmit="saveProfile(event)">
                    <input type="hidden" id="profileId">
                    <div class="grid grid-2 gap-3">
                        <div class="form-group"><label class="form-label">Profile Name</label><input type="text" id="profileName" class="form-input" required placeholder="e.g. Movies AV1 1080p"></div>
                        <div class="form-group"><label class="form-label">Library Type</label>
                            <select id="profileLibraryType" class="form-select">
                                <option value="movie">üé¨ Movies</option><option value="tv_show">üì∫ TV Shows</option><option value="anime">üéå Anime</option><option value="home_video">üé• Home Videos</option><option value="4k_content">üñ•Ô∏è 4K/UHD</option><option value="web_content">üåê Web/YouTube</option><option value="archive">üì¶ Archive</option><option value="music_video">üéµ Music Videos</option><option value="custom">‚öôÔ∏è Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-3 gap-3">
                        <div class="form-group"><label class="form-label">Codec</label>
                            <select id="profileCodec" class="form-select"><option value="av1">AV1 ‚≠ê</option><option value="h265">H.265 (HEVC)</option><option value="h264">H.264 (AVC)</option><option value="vp9">VP9</option></select>
                        </div>
                        <div class="form-group"><label class="form-label">Encoder</label>
                            <select id="profileEncoder" class="form-select" onchange="updatePresetOptions()">
                                <option value="svt_av1">SVT-AV1</option><option value="x265">x265</option><option value="x264">x264</option><option value="nvenc_h264">NVENC H.264</option><option value="nvenc_h265">NVENC H.265</option><option value="nvenc_av1">NVENC AV1</option><option value="qsv_h264">QSV H.264</option><option value="qsv_h265">QSV H.265</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">Quality (CRF)</label><input type="number" id="profileQuality" class="form-input" value="28" min="0" max="63"></div>
                    </div>
                    <div class="grid grid-3 gap-3">
                        <div class="form-group"><label class="form-label">Preset</label><select id="profilePreset" class="form-select"></select><div class="form-hint" id="presetHelp">Speed vs quality trade-off</div></div>
                        <div class="form-group"><label class="form-label">Container</label><select id="profileContainer" class="form-select"><option value="mkv">MKV</option><option value="mp4">MP4</option><option value="webm">WebM</option></select></div>
                        <div class="form-group"><label class="form-label">Resolution</label>
                            <select id="profileResolution" class="form-select"><option value="">Preserve</option><option value="3840x2160">4K</option><option value="2560x1440">1440p</option><option value="1920x1080">1080p</option><option value="1280x720">720p</option><option value="854x480">480p</option></select>
                        </div>
                    </div>
                    <div class="grid grid-2 gap-3">
                        <div class="form-group"><label class="form-label">Audio Codec</label>
                            <select id="profileAudioCodec" class="form-select"><option value="copy">Copy</option><option value="aac">AAC</option><option value="opus">Opus</option><option value="ac3">AC3</option><option value="eac3">E-AC3</option><option value="flac">FLAC</option></select>
                        </div>
                        <div class="form-group"><label class="form-label">Audio Bitrate</label>
                            <select id="profileAudioBitrate" class="form-select"><option value="128">128k</option><option value="160">160k</option><option value="192" selected>192k</option><option value="256">256k</option><option value="320">320k</option></select>
                        </div>
                    </div>
                    <label class="form-checkbox mt-2"><input type="checkbox" id="profileTwoPass"><span>Two-pass encoding</span></label>
                    <label class="form-checkbox mt-2"><input type="checkbox" id="profileHwAccel" onchange="checkHwAccel()"><span>Hardware acceleration</span></label>
                    <div class="form-hint" id="hwAccelHelp">Use GPU encoding</div>
                    <label class="form-checkbox mt-2"><input type="checkbox" id="profileIsDefault"><span>Set as default profile</span></label>

                    <!-- Advanced Section -->
                    <button type="button" class="collapse-toggle mt-4" onclick="toggleCollapse('advancedSection', this)"><span class="chevron">‚ñ∂</span> Advanced Settings</button>
                    <div id="advancedSection" class="collapse-content">
                        <div class="grid grid-2 gap-3">
                            <div class="form-group"><label class="form-label">Audio Handling</label>
                                <select id="profileAudioHandling" class="form-select"><option value="preserve_all">üîä Preserve All</option><option value="keep_primary">üîà Primary Only</option><option value="stereo_mixdown">üéß Stereo</option><option value="hd_plus_aac">üé≠ HD+AAC</option><option value="high_quality">üéµ HQ Audio</option></select>
                                <div class="form-hint" id="audioHandlingHelp"></div>
                            </div>
                            <div class="form-group"><label class="form-label">Subtitle Handling</label>
                                <select id="profileSubtitleHandling" class="form-select"><option value="preserve_all">üí¨ All Subs</option><option value="keep_english">üá∫üá∏ English</option><option value="burn_in">üî• Burn-in</option><option value="foreign_scan">üåç Foreign Scan</option><option value="none">‚ùå None</option></select>
                                <div class="form-hint" id="subtitleHandlingHelp"></div>
                            </div>
                        </div>
                        <div class="grid grid-2 gap-3">
                            <div class="form-group"><label class="form-label">Framerate</label>
                                <select id="profileFramerate" class="form-select" onchange="handleFramerateChange()"><option value="">Preserve</option><option value="23.976">23.976</option><option value="24">24</option><option value="25">25</option><option value="29.97">29.97</option><option value="30">30</option><option value="60">60</option><option value="custom">Custom</option></select>
                                <input type="number" id="profileFramerateCustom" class="form-input hidden mt-2" step="0.001" placeholder="FPS">
                            </div>
                            <div class="form-group"><label class="form-label">Deinterlace</label>
                                <select id="profileDeinterlace" class="form-select"><option value="">Off</option><option value="yadif">Yadif</option><option value="decomb">Decomb</option></select>
                            </div>
                        </div>
                        <label class="form-checkbox mt-2"><input type="checkbox" id="profileChapterMarkers" checked><span>Preserve chapter markers</span></label>
                        <label class="form-checkbox mt-2"><input type="checkbox" id="profileWebOptimized"><span>Web-optimized</span></label>
                        <label class="form-checkbox mt-2"><input type="checkbox" id="profileEnableFilters"><span>Enable video filters</span></label>
                        <div class="form-group mt-3">
                            <label class="form-label">Custom HandBrake Arguments</label>
                            <textarea id="profileCustomArgs" class="form-input" rows="2" placeholder="e.g. --encoder-tune animation" style="font-family:monospace;font-size:12px"></textarea>
                            <div class="form-hint">Additional CLI flags passed directly to HandBrakeCLI</div>
                        </div>
                    </div>

                    <!-- AI Upscaling Section -->
                    <button type="button" class="collapse-toggle mt-3" onclick="toggleCollapse('profileUpscaleSection', this)"><span class="chevron" id="profileUpscaleToggleIcon">‚ñ∂</span> AI Upscaling <span id="profileUpscaleEnabledBadge" class="hidden" style="color:var(--green);font-size:11px;margin-left:6px">‚óè ON</span></button>
                    <div id="profileUpscaleSection" class="collapse-content">
                        <label class="form-checkbox"><input type="checkbox" id="profileUpscaleEnabled" onchange="document.getElementById('profileUpscaleEnabledBadge').classList.toggle('hidden', !this.checked)"><span>Enable AI upscaling</span></label>
                        <div id="profileUpscaleFields" class="mt-3">
                            <div class="grid grid-3 gap-3">
                                <div class="form-group"><label class="form-label">Trigger Below</label><input type="number" id="profileUpscaleTrigger" class="form-input" value="720" min="240" max="2160"></div>
                                <div class="form-group"><label class="form-label">Target Height</label><input type="number" id="profileUpscaleTarget" class="form-input" value="1080" min="480" max="4320"></div>
                                <div class="form-group"><label class="form-label">Upscaler</label>
                                    <select id="profileUpscaleKey" class="form-select"><option value="realesrgan">Real-ESRGAN</option><option value="waifu2x">Waifu2x</option><option value="realcugan">Real-CUGAN</option></select>
                                </div>
                            </div>
                            <div class="grid grid-2 gap-3 mt-2">
                                <div class="form-group"><label class="form-label">Model</label>
                                    <select id="profileUpscaleModel" class="form-select"><option value="realesrgan-x4plus">realesrgan-x4plus</option><option value="realesrgan-x4plus-anime">realesrgan-x4plus-anime</option><option value="realesr-animevideov3">realesr-animevideov3</option></select>
                                </div>
                                <div class="form-group"><label class="form-label">Scale Factor</label>
                                    <select id="profileUpscaleFactor" class="form-select"><option value="2">2√ó</option><option value="3">3√ó</option><option value="4" selected>4√ó</option></select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('profileForm').requestSubmit()">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- Scan Root Modal -->
    <div class="modal-backdrop hidden" id="scanRootModal">
        <div class="modal-panel">
            <div class="modal-header"><h3 class="modal-title" id="scanRootModalTitle">Add Library</h3><button class="modal-close" onclick="closeScanRootModal()">&times;</button></div>
            <div class="modal-body">
                <form id="scanRootForm" onsubmit="saveScanRoot(event)">
                    <input type="hidden" id="scanRootId">
                    <div class="form-group"><label class="form-label">Path</label>
                        <div class="flex gap-2"><input type="text" id="scanRootPath" class="form-input" required placeholder="/media/movies"><button type="button" class="btn btn-secondary btn-sm" onclick="browseFolderPath()">Browse</button></div>
                    </div>
                    <div class="grid grid-2 gap-3">
                        <div class="form-group"><label class="form-label">Library Type</label>
                            <select id="scanRootLibraryType" class="form-select" onchange="handleLibraryTypeChange()"><option value="movie">üé¨ Movies</option><option value="tv_show">üì∫ TV Shows</option><option value="anime">üéå Anime</option><option value="home_video">üé• Home Videos</option><option value="4k_content">üñ•Ô∏è 4K/UHD</option><option value="web_content">üåê Web/YouTube</option><option value="archive">üì¶ Archive</option><option value="music_video">üéµ Music Videos</option><option value="custom">‚öôÔ∏è Custom</option></select>
                        </div>
                        <div class="form-group"><label class="form-label">Profile</label><select id="scanRootProfile" class="form-select"></select></div>
                    </div>
                    <div id="libraryTypeRecommendation" class="card card-compact hidden mt-2" style="background:var(--info-dim);border-color:rgba(52,152,219,0.15)"></div>
                    <label class="form-checkbox mt-3"><input type="checkbox" id="scanRootEnabled" checked><span>Enabled</span></label>
                    <label class="form-checkbox mt-2"><input type="checkbox" id="scanRootRecursive" checked><span>Scan subdirectories recursively</span></label>
                    <label class="form-checkbox mt-2"><input type="checkbox" id="scanRootShowInStats" checked><span>Show in statistics</span></label>
                    <!-- Scan Root Upscale Override -->
                    <button type="button" class="collapse-toggle mt-3" onclick="toggleCollapse('upscaleSettingsFields', this)"><span class="chevron" id="upscaleSectionToggleIcon">‚ñ∂</span> AI Upscale Override <span id="upscaleEnabledBadge" class="hidden" style="color:var(--green);font-size:11px;margin-left:6px">‚óè ON</span></button>
                    <div id="upscaleSettingsFields" class="collapse-content">
                        <div class="form-hint mb-2">Override the profile's upscale settings for this library</div>
                        <label class="form-checkbox"><input type="checkbox" id="scanRootUpscaleEnabled" onchange="document.getElementById('upscaleEnabledBadge').classList.toggle('hidden', !this.checked)"><span>Enable AI upscaling</span></label>
                        <div class="grid grid-3 gap-3 mt-3">
                            <div class="form-group"><label class="form-label">Trigger Below</label><input type="number" id="scanRootUpscaleTrigger" class="form-input" value="720" min="240" max="2160"></div>
                            <div class="form-group"><label class="form-label">Target Height</label><input type="number" id="scanRootUpscaleTarget" class="form-input" value="1080" min="480" max="4320"></div>
                            <div class="form-group"><label class="form-label">Upscaler</label>
                                <select id="scanRootUpscaleKey" class="form-select"><option value="realesrgan">Real-ESRGAN</option><option value="waifu2x">Waifu2x</option><option value="realcugan">Real-CUGAN</option></select>
                            </div>
                        </div>
                        <div class="grid grid-2 gap-3 mt-2">
                            <div class="form-group"><label class="form-label">Model</label>
                                <select id="scanRootUpscaleModel" class="form-select"><option value="realesrgan-x4plus">realesrgan-x4plus</option><option value="realesrgan-x4plus-anime">realesrgan-x4plus-anime</option><option value="realesr-animevideov3">realesr-animevideov3</option></select>
                            </div>
                            <div class="form-group"><label class="form-label">Scale Factor</label>
                                <select id="scanRootUpscaleFactor" class="form-select"><option value="2">2√ó</option><option value="3">3√ó</option><option value="4" selected>4√ó</option></select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeScanRootModal()">Cancel</button><button class="btn btn-primary" onclick="document.getElementById('scanRootForm').requestSubmit()">Save</button></div>
        </div>
    </div>

    <!-- Watch Modal -->
    <div class="modal-backdrop hidden" id="watchModal">
        <div class="modal-panel">
            <div class="modal-header"><h3 class="modal-title" id="watchModalTitle">Add Folder Watch</h3><button class="modal-close" onclick="closeWatchModal()">&times;</button></div>
            <div class="modal-body">
                <form id="watchForm" onsubmit="saveWatch(event)">
                    <input type="hidden" id="watchId">
                    <div class="form-group"><label class="form-label">Watch Path</label><input type="text" id="watchPath" class="form-input" required placeholder="/media/incoming"></div>
                    <div class="form-group"><label class="form-label">Profile</label><select id="watchProfile" class="form-select"></select></div>
                    <div class="form-group"><label class="form-label">Extensions</label><input type="text" id="watchExtensions" class="form-input" value=".mkv,.mp4,.avi,.mov,.wmv,.flv,.webm,.m4v,.ts,.mpg,.mpeg"></div>
                    <div class="flex gap-4 mt-3">
                        <label class="form-checkbox"><input type="checkbox" id="watchEnabled" checked> Enabled</label>
                        <label class="form-checkbox"><input type="checkbox" id="watchRecursive" checked> Recursive</label>
                        <label class="form-checkbox"><input type="checkbox" id="watchAutoQueue" checked> Auto Queue</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeWatchModal()">Cancel</button><button class="btn btn-primary" onclick="document.getElementById('watchForm').requestSubmit()">Save</button></div>
        </div>
    </div>

    <!-- Connection Modal -->
    <div class="modal-backdrop hidden" id="connectionModal">
        <div class="modal-panel">
            <div class="modal-header"><h3 class="modal-title" id="connectionModalTitle">Add Connection</h3><button class="modal-close" onclick="closeConnectionModal()">&times;</button></div>
            <div class="modal-body">
                <form id="connectionForm" onsubmit="saveConnection(event)">
                    <input type="hidden" id="connectionId">
                    <div class="grid grid-2 gap-3">
                        <div class="form-group"><label class="form-label">Name</label><input type="text" id="connectionName" class="form-input" required placeholder="My Sonarr"></div>
                        <div class="form-group"><label class="form-label">Type</label><select id="connectionAppType" class="form-select" onchange="handleConnectionTypeChange()"><option value="sonarr">Sonarr</option><option value="radarr">Radarr</option><option value="stash">Stash</option></select></div>
                    </div>
                    <div class="form-group"><label class="form-label">URL</label><input type="url" id="connectionUrl" class="form-input" required placeholder="http://localhost:8989"><div class="form-hint" id="connectionUrlHint"></div></div>
                    <div class="form-group"><label class="form-label">API Key</label><input type="password" id="connectionApiKey" class="form-input" required><div class="form-hint" id="connectionKeyHint"></div></div>
                    <div class="form-group"><label class="form-label">Scan Root</label><select id="connectionScanRoot" class="form-select"><option value="">‚Äî None (manual only) ‚Äî</option></select></div>
                    <label class="form-checkbox mt-3"><input type="checkbox" id="connectionEnabled" checked><span>Enabled</span></label>
                    <label class="form-checkbox mt-2"><input type="checkbox" id="connectionShowInStats" checked><span>Show in statistics</span></label>
                    <div class="form-hint mt-2 hidden" id="connectionPrivacyNote"></div>
                    <div id="connectionTestResult" class="hidden mt-3 p-3 rounded text-sm" style="background:var(--bg-overlay)"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="testConnection()">üß™ Test</button>
                <div style="flex:1"></div>
                <button class="btn btn-secondary" onclick="closeConnectionModal()">Cancel</button>
                <button id="connectionSaveBtn" class="btn btn-primary" onclick="document.getElementById('connectionForm').requestSubmit()">Save</button>
            </div>
        </div>
    </div>

    <!-- Folder Browser Modal -->
    <div class="modal-backdrop hidden" id="folderBrowserModal">
        <div class="modal-panel" style="max-width:560px;max-height:70vh">
            <div class="modal-header"><h3 class="modal-title">Browse Folders</h3><button class="modal-close" onclick="closeFolderBrowser()">&times;</button></div>
            <div class="modal-body" style="padding:0">
                <div style="padding:12px 22px;border-bottom:1px solid var(--border-subtle);display:flex;align-items:center;gap:8px">
                    <span class="text-xs text-muted">Path:</span>
                    <code class="text-sm text-accent" id="folderBrowserPath">Root</code>
                </div>
                <div id="folderBrowserList" style="max-height:400px;overflow-y:auto;padding:8px"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeFolderBrowser()">Cancel</button><button class="btn btn-primary" onclick="selectCurrentFolder()">Select Folder</button></div>
        </div>
    </div>

    <!-- Codec Guide Modal -->
    <div class="modal-backdrop hidden" id="codecGuideModal">
        <div class="modal-panel" style="max-width:580px">
            <div class="modal-header"><h3 class="modal-title">Video Codec Guide</h3><button class="modal-close" onclick="document.getElementById('codecGuideModal').classList.add('hidden')">&times;</button></div>
            <div class="modal-body" id="codecGuideContent"></div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
