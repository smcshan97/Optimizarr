<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizarr - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <!-- Navigation - Full width -->
    <nav class="bg-gray-800 border-b border-gray-700 px-4 sm:px-6 lg:px-8 xl:px-10 py-4">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-blue-400">Optimizarr</h1>
                <p class="text-sm text-gray-400">Automated Media Optimization</p>
            </div>
            <div class="flex items-center gap-4">
                <span id="username" class="text-gray-300"></span>
                <button onclick="switchTab('settings')" 
                    class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm"
                    title="Settings">‚öôÔ∏è</button>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content - Fluid layout for ultra-wide displays -->
    <div class="w-full px-4 sm:px-6 lg:px-8 xl:px-10 py-6">
        <!-- Stats Cards - Adaptive grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-4 2xl:grid-cols-8 gap-4 mb-6">
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-gray-400 text-xs mb-1">Space Saved</h3>
                <p id="spaceSaved" class="text-2xl font-bold text-green-400">0 GB</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-gray-400 text-xs mb-1">Files Processed</h3>
                <p id="filesProcessed" class="text-2xl font-bold text-blue-400">0</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-gray-400 text-xs mb-1">Queue Pending</h3>
                <p id="queuePending" class="text-2xl font-bold text-yellow-400">0</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-gray-400 text-xs mb-1">Active Jobs</h3>
                <p id="activeJobs" class="text-2xl font-bold text-purple-400">0</p>
            </div>
        </div>

        <!-- Resource Monitoring Cards - Adaptive -->
        <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-gray-400 text-sm mb-2">CPU Usage</h3>
                <div class="flex items-end gap-2">
                    <p id="cpuUsage" class="text-3xl font-bold text-cyan-400">0%</p>
                    <span id="cpuStatus" class="text-sm text-gray-500 mb-1"></span>
                </div>
                <div class="mt-3 bg-gray-700 rounded-full h-2">
                    <div id="cpuBar" class="bg-cyan-400 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-gray-400 text-sm mb-2">Memory Usage</h3>
                <div class="flex items-end gap-2">
                    <p id="memoryUsage" class="text-3xl font-bold text-purple-400">0%</p>
                    <span id="memoryStatus" class="text-sm text-gray-500 mb-1"></span>
                </div>
                <div class="mt-3 bg-gray-700 rounded-full h-2">
                    <div id="memoryBar" class="bg-purple-400 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-gray-400 text-sm mb-2">GPU Usage</h3>
                <div class="flex items-end gap-2">
                    <p id="gpuUsage" class="text-3xl font-bold text-orange-400">N/A</p>
                    <span id="gpuStatus" class="text-sm text-gray-500 mb-1"></span>
                </div>
                <div class="mt-3 bg-gray-700 rounded-full h-2">
                    <div id="gpuBar" class="bg-orange-400 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6">
            <div class="border-b border-gray-700">
                <nav class="flex gap-8">
                    <button onclick="switchTab('queue')" id="tab-queue" class="tab-button active">Queue</button>
                    <button onclick="switchTab('profiles')" id="tab-profiles" class="tab-button">Profiles</button>
                    <button onclick="switchTab('scanroots')" id="tab-scanroots" class="tab-button">Scan Roots</button>
                    <button onclick="switchTab('watches')" id="tab-watches" class="tab-button">Watches</button>
                    <button onclick="switchTab('statistics')" id="tab-statistics" class="tab-button">Statistics</button>
                    <button onclick="switchTab('schedule')" id="tab-schedule" class="tab-button">Schedule</button>
                    <button onclick="switchTab('logs')" id="tab-logs" class="tab-button">Logs</button>
                    <button onclick="switchTab('settings')" id="tab-settings" class="tab-button">Settings</button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="content-queue" class="tab-content">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Encoding Queue</h2>
                    <div class="flex gap-3">
                        <button onclick="reprobeQueue()" id="reprobeBtn"
                            class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded flex items-center gap-2 text-sm"
                            title="Re-detect codec and resolution for UNKNOWN items">
                            <span id="reproBtnIcon">üî¨</span>
                            <span id="reproBtnText">Re-probe</span>
                        </button>
                        <button onclick="clearCompleted()" 
                            class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-sm"
                            title="Remove all completed items from queue">
                            ‚úÖ Clear Done
                        </button>
                        <button onclick="scanAllRoots()" id="scanAllBtn" 
                            class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded flex items-center gap-2">
                            <span id="scanAllIcon">üîç</span>
                            <span id="scanAllText">Scan All</span>
                        </button>
                        <button onclick="startEncoding()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                            ‚ñ∂Ô∏è Start
                        </button>
                        <button onclick="stopEncoding()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                </div>
                
                <!-- Filters & Sort Controls -->
                <div class="mb-4 flex flex-wrap gap-3 items-center">
                    <div class="flex-1 min-w-48">
                        <input type="text" id="queueSearch" placeholder="üîç Search by filename..." 
                            onkeyup="filterQueue()"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                    </div>
                    <div>
                        <select id="queueStatusFilter" onchange="filterQueue()"
                            class="bg-gray-700 border border-gray-600 rounded px-4 py-2">
                            <option value="">All Statuses</option>
                            <option value="pending">‚è≥ Pending</option>
                            <option value="processing">‚öôÔ∏è Processing</option>
                            <option value="completed">‚úÖ Completed</option>
                            <option value="failed">‚ùå Failed</option>
                            <option value="paused">‚è∏Ô∏è Paused</option>
                        </select>
                    </div>
                    <!-- Sort & Prioritize -->
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400 whitespace-nowrap">Prioritize by:</span>
                        <select id="queueSortBy" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                            <option value="default">Default</option>
                            <option value="file_size">File Size ‚Üì</option>
                            <option value="estimated_savings">Savings ‚Üì</option>
                            <option value="filename">Filename A‚ÜíZ</option>
                        </select>
                        <button onclick="applyQueuePriority()" title="Apply priority to queue"
                            class="bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded text-sm whitespace-nowrap">
                            ‚Üë Apply
                        </button>
                    </div>
                    <div>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" id="autoRefreshQueue" checked onchange="toggleAutoRefresh()">
                            <span>Auto-refresh</span>
                        </label>
                    </div>
                </div>
                
                <!-- Bulk Actions Bar (hidden until selection) -->
                <div id="bulkActionsBar" class="hidden mb-4 p-3 bg-gray-700 rounded-lg flex items-center gap-4">
                    <span id="bulkSelectedCount" class="text-sm text-blue-400 font-medium"></span>
                    <button onclick="bulkDeleteSelected()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                        üóëÔ∏è Delete Selected
                    </button>
                    <button onclick="bulkClearCompleted()" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-sm">
                        ‚úÖ Clear Completed
                    </button>
                    <button onclick="deselectAll()" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-sm">
                        Deselect All
                    </button>
                </div>
                
                <div id="queueTable" class="overflow-x-auto">
                    <p class="text-gray-400">Loading queue...</p>
                </div>
            </div>
        </div>

        <div id="content-profiles" class="tab-content hidden">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Encoding Profiles</h2>
                    <div class="flex gap-2">
                        <button onclick="seedDefaultProfiles()" 
                            class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded text-sm" 
                            title="Add missing built-in default profiles">
                            ‚ûï Add Defaults
                        </button>
                        <button onclick="exportProfiles()" class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded text-sm" title="Export all profiles as JSON">
                            üì§ Export
                        </button>
                        <label class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded text-sm cursor-pointer" title="Import profiles from JSON">
                            üì• Import
                            <input type="file" accept=".json" onchange="importProfiles(event)" class="hidden">
                        </label>
                        <button onclick="showCreateProfileForm()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            New Profile
                        </button>
                    </div>
                </div>
                
                <div id="profilesList">
                    <p class="text-gray-400">Loading profiles...</p>
                </div>
            </div>
        </div>

        <div id="content-scanroots" class="tab-content hidden">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Scan Roots</h2>
                    <button onclick="showCreateScanRootForm()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                        Add Scan Root
                    </button>
                </div>
                
                <div id="scanRootsList">
                    <p class="text-gray-400">Loading scan roots...</p>
                </div>
            </div>
        </div>

        <div id="content-settings" class="tab-content hidden">
            <!-- Account Management Section -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-bold mb-6">Account Management</h2>
                
                <div class="space-y-6">
                    <!-- Change Password -->
                    <div class="border-b border-gray-700 pb-6">
                        <h3 class="text-lg font-semibold mb-4">Change Password</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Current Password</label>
                                <input type="password" id="currentPassword" 
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                                    placeholder="Enter current password">
                            </div>
                            <div></div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">New Password</label>
                                <input type="password" id="newPassword" 
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                                    placeholder="Enter new password">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Confirm New Password</label>
                                <input type="password" id="confirmPassword" 
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                                    placeholder="Confirm new password">
                            </div>
                        </div>
                        <button onclick="changePassword()" 
                            class="mt-4 bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded">
                            Update Password
                        </button>
                    </div>
                    
                    <!-- Account Information -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Account Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                                <input type="text" id="accountUsername" readonly
                                    class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-gray-400 cursor-not-allowed">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Role</label>
                                <input type="text" id="accountRole" readonly
                                    class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-gray-400 cursor-not-allowed">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Resource Management Section -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-bold mb-6">Resource Management Settings</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- CPU Threshold -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            CPU Threshold (%)
                        </label>
                        <input 
                            type="number" 
                            id="cpuThreshold" 
                            min="50" 
                            max="100" 
                            step="5"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                            value="90"
                        >
                        <p class="text-sm text-gray-400 mt-1">Pause encoding if CPU usage exceeds this threshold</p>
                    </div>
                    
                    <!-- Memory Threshold -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Memory Threshold (%)
                        </label>
                        <input 
                            type="number" 
                            id="memoryThreshold" 
                            min="50" 
                            max="100" 
                            step="5"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                            value="85"
                        >
                        <p class="text-sm text-gray-400 mt-1">Pause encoding if memory usage exceeds this threshold</p>
                    </div>
                    
                    <!-- GPU Threshold -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            GPU Threshold (%)
                        </label>
                        <input 
                            type="number" 
                            id="gpuThreshold" 
                            min="50" 
                            max="100" 
                            step="5"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                            value="90"
                        >
                        <p class="text-sm text-gray-400 mt-1">Pause encoding if GPU usage exceeds this threshold</p>
                    </div>
                    
                    <!-- Nice Level -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Process Priority (Nice Level)
                        </label>
                        <input 
                            type="number" 
                            id="niceLevel" 
                            min="0" 
                            max="19" 
                            step="1"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                            value="10"
                        >
                        <p class="text-sm text-gray-400 mt-1">Higher = lower priority (0-19)</p>
                    </div>
                    
                    <!-- Enable Throttling -->
                    <div class="md:col-span-2">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="enableThrottling" 
                                class="w-5 h-5 bg-gray-700 border-gray-600 rounded"
                                checked
                            >
                            <span class="text-sm font-medium text-gray-300">
                                Enable automatic resource throttling
                            </span>
                        </label>
                        <p class="text-sm text-gray-400 mt-1 ml-8">
                            Automatically pause/resume encoding based on system resource usage
                        </p>
                    </div>
                </div>
                
                <!-- Preset Buttons -->
                <div class="mt-8 pt-6 border-t border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Quick Presets</h3>
                    <div class="flex gap-3">
                        <button onclick="applyPreset('conservative')" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                            Conservative (CPU: 70%, Mem: 70%, Nice: 15)
                        </button>
                        <button onclick="applyPreset('balanced')" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                            Balanced (CPU: 85%, Mem: 80%, Nice: 10)
                        </button>
                        <button onclick="applyPreset('aggressive')" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                            Aggressive (CPU: 95%, Mem: 90%, Nice: 5)
                        </button>
                    </div>
                </div>
                
                <!-- Save Button -->
                <div class="mt-6 flex justify-end">
                    <button onclick="saveResourceSettings()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded font-medium">
                        Save Settings
                    </button>
                </div>
                
                <div id="settingsMessage" class="mt-4 hidden"></div>
            </div>

            <!-- AI Upscalers Section -->
            <div class="bg-gray-800 rounded-lg p-6 mt-6">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <h2 class="text-xl font-bold">ü§ñ AI Upscalers</h2>
                        <p class="text-sm text-gray-400 mt-1">
                            Pre-encode resolution enhancement (e.g. 480p‚Üí1080p). Click <strong>Download</strong> to install automatically.
                        </p>
                    </div>
                    <button onclick="checkUpscalerUpdates()" class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded text-sm">
                        üîÑ Check Updates
                    </button>
                </div>
                <div id="upscalerStatus" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mt-4">
                    <p class="text-gray-500 text-sm">Loading‚Ä¶</p>
                </div>
            </div>

            <!-- External Connections Section -->
            <div class="bg-gray-800 rounded-lg p-6 mt-6">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <h2 class="text-xl font-bold">üîå External Connections</h2>
                        <p class="text-sm text-gray-400 mt-1">
                            Connect Sonarr or Radarr to import libraries and receive automatic download events.
                        </p>
                    </div>
                    <button onclick="showAddConnectionModal()"
                        class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-medium transition-colors">
                        + Add Connection
                    </button>
                </div>
                <div id="connectionsList" class="space-y-3 mt-4">
                    <p class="text-gray-500 text-sm">Loading‚Ä¶</p>
                </div>
            </div>

            <!-- Backup & Restore Section -->
            <div class="bg-gray-800 rounded-lg p-6 mt-6">
                <h2 class="text-xl font-bold mb-1">üíæ Backup & Restore</h2>
                <p class="text-sm text-gray-400 mb-6">Download a complete backup of your database (profiles, scan roots, queue, history) or restore from a previous backup.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Backup -->
                    <div class="bg-gray-700 rounded-lg p-5">
                        <h3 class="font-semibold mb-1">üì§ Download Backup</h3>
                        <p class="text-xs text-gray-400 mb-4">Downloads the full SQLite database as a <code class="bg-gray-900 px-1 rounded">.db</code> file. Includes everything: profiles, scan roots, watch folders, history, and settings.</p>
                        <button onclick="downloadBackup()"
                            class="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded text-sm font-medium transition-colors">
                            Download Backup
                        </button>
                    </div>

                    <!-- Restore -->
                    <div class="bg-gray-700 rounded-lg p-5">
                        <h3 class="font-semibold mb-1">üì• Restore from Backup</h3>
                        <p class="text-xs text-gray-400 mb-3">Upload a previously downloaded <code class="bg-gray-900 px-1 rounded">.db</code> file. <strong class="text-yellow-300">Overwrites your current database.</strong> Optimizarr must be restarted after restore.</p>
                        <div class="flex items-center gap-3">
                            <label class="bg-gray-600 hover:bg-gray-500 px-5 py-2 rounded text-sm font-medium cursor-pointer transition-colors">
                                Choose File
                                <input type="file" accept=".db" onchange="restoreBackup(event)" class="hidden">
                            </label>
                            <span id="restoreFileName" class="text-xs text-gray-400">No file chosen</span>
                        </div>
                        <div id="restoreStatus" class="mt-3 text-xs hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- External Connection Modal -->
        <div id="connectionModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-lg">
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-xl font-bold" id="connectionModalTitle">Add Connection</h3>
                    <button onclick="closeConnectionModal()" class="text-gray-400 hover:text-white text-xl">‚úï</button>
                </div>

                <form id="connectionForm" class="space-y-4" onsubmit="return false;">
                    <input type="hidden" id="connectionId">

                    <!-- App Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">App Type *</label>
                        <select id="connectionAppType"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            <option value="radarr">üìΩÔ∏è Radarr (Movies)</option>
                            <option value="sonarr">üì∫ Sonarr (TV Shows)</option>
                            <option value="stash" disabled class="text-gray-500">üîí Stash (Coming Soon)</option>
                        </select>
                    </div>

                    <!-- Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Display Name *</label>
                        <input type="text" id="connectionName"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                            placeholder="e.g. Radarr ‚Äî 4K Movies">
                    </div>

                    <!-- Base URL -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">URL *</label>
                        <input type="url" id="connectionUrl"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                            placeholder="http://localhost:7878">
                        <p class="text-xs text-gray-500 mt-1">Radarr default: :7878 ¬∑ Sonarr default: :8989</p>
                    </div>

                    <!-- API Key -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">API Key *</label>
                        <div class="relative">
                            <input type="password" id="connectionApiKey"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white pr-16"
                                placeholder="Paste your API key here">
                            <button type="button" onclick="toggleConnectionKeyVisibility()"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400 hover:text-white px-2 py-1 bg-gray-600 rounded">
                                Show
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Settings ‚Üí General ‚Üí API Key in Sonarr/Radarr</p>
                    </div>

                    <!-- Show in Stats -->
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="connectionShowInStats" checked
                            class="w-4 h-4 bg-gray-700 border-gray-600 rounded">
                        <label for="connectionShowInStats" class="text-sm text-gray-300 cursor-pointer">
                            Show files from this connection in Statistics
                        </label>
                    </div>

                    <!-- Link to Scan Root -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Link to Scan Root <span class="text-gray-500 font-normal">(optional)</span></label>
                        <select id="connectionScanRoot"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            <option value="">‚Äî None (use default profile) ‚Äî</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Files from this connection will use the linked scan root's profile</p>
                    </div>

                    <!-- Test result banner -->
                    <div id="connectionTestResult" class="hidden rounded px-4 py-2 text-sm"></div>

                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="testConnectionForm()"
                            class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-sm transition-colors">
                            üîå Test Connection
                        </button>
                        <div class="flex-1"></div>
                        <button type="button" onclick="closeConnectionModal()"
                            class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-sm">Cancel</button>
                        <button type="button" id="connectionSaveBtn" onclick="saveConnection()"
                            class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded text-sm font-medium transition-colors">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Profile Modal -->
        <div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold" id="profileModalTitle">Create Profile</h3>
                    <button onclick="closeProfileModal()" class="text-gray-400 hover:text-white">‚úï</button>
                </div>
                
                <form id="profileForm" class="space-y-4">
                    <input type="hidden" id="profileId">
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Profile Name *</label>
                        <input type="text" id="profileName" required 
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2"
                            placeholder="e.g., 1080p AV1 High Quality">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <label class="block text-sm font-medium">Codec *</label>
                                <button type="button" onclick="showCodecGuide()" 
                                    class="text-blue-400 hover:text-blue-300 text-xs" title="Codec Guide">
                                    ‚ÑπÔ∏è Guide
                                </button>
                            </div>
                            <select id="profileCodec" required 
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                                <option value="h264">H.264</option>
                                <option value="h265">H.265 (HEVC)</option>
                                <option value="av1" selected>AV1 ‚≠ê</option>
                                <option value="vp9">VP9</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Encoder *</label>
                            <select id="profileEncoder" required onchange="updatePresetOptions()"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                                <option value="x264">x264 (CPU)</option>
                                <option value="x265">x265 (CPU)</option>
                                <option value="svt_av1" selected>SVT-AV1 (CPU) ‚≠ê</option>
                                <option value="nvenc_h264">NVENC H.264 (GPU)</option>
                                <option value="nvenc_h265">NVENC H.265 (GPU)</option>
                                <option value="nvenc_av1">NVENC AV1 (GPU)</option>
                                <option value="qsv_h264">QuickSync H.264 (GPU)</option>
                                <option value="qsv_h265">QuickSync H.265 (GPU)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Resolution</label>
                            <select id="profileResolution" 
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                                <option value="">Preserve Source (recommended)</option>
                                <option value="1920x1080">1920x1080 (1080p/HD)</option>
                                <option value="2560x1440">2560x1440 (1440p/2K)</option>
                                <option value="3840x2160">3840x2160 (2160p/4K)</option>
                                <option value="7680x4320">7680x4320 (4320p/8K)</option>
                            </select>
                            <p class="text-xs text-gray-400 mt-1">Leave empty to keep original quality</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Framerate (FPS)</label>
                            <select id="profileFramerate" onchange="handleFramerateChange()"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                                <option value="">Variable (VFR) - Preserve Source</option>
                                <option value="24">24 fps (Movies)</option>
                                <option value="30">30 fps (Standard TV)</option>
                                <option value="60">60 fps (Action/Sports)</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <input type="number" id="profileFramerateCustom" 
                                class="hidden w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 mt-2"
                                placeholder="Enter FPS (e.g., 25, 48, 120)" min="1" max="240">
                            <p class="text-xs text-gray-400 mt-1">24=Movies, 30=TV, 60=Sports/Action</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Quality (CRF) *</label>
                            <input type="number" id="profileQuality" required min="18" max="51" value="28"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                            <p class="text-xs text-gray-400 mt-1">Lower = better quality (18-28 recommended)</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Preset</label>
                            <select id="profilePreset" 
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                                <option value="">Auto (recommended)</option>
                                <!-- Options populated dynamically based on encoder -->
                            </select>
                            <p class="text-xs text-gray-400 mt-1" id="presetHelp">Speed vs quality trade-off</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Audio Codec *</label>
                            <select id="profileAudioCodec" required 
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                                <option value="aac">AAC</option>
                                <option value="opus">Opus</option>
                                <option value="ac3">AC3</option>
                                <option value="flac">FLAC (Lossless)</option>
                                <option value="passthrough">Passthrough (copy)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Container Format *</label>
                            <select id="profileContainer" required 
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                                <option value="mkv" selected>MKV (recommended)</option>
                                <option value="mp4">MP4 (max compatibility)</option>
                                <option value="webm">WebM (web streaming)</option>
                            </select>
                            <p class="text-xs text-gray-400 mt-1">MKV supports all codecs/subs; MP4 for Apple/mobile</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="profileTwoPass" class="mr-2">
                            <span class="text-sm">Enable two-pass encoding (better quality, slower)</span>
                        </label>
                    </div>
                    
                    <!-- Phase 2: Audio/Subtitle/Filters Section -->
                    <div class="border-t border-gray-600 pt-4 mt-2">
                        <h4 class="text-sm font-bold text-blue-400 mb-3">üîß Advanced: Audio, Subtitles & Filters</h4>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Audio Handling</label>
                                <select id="profileAudioHandling" 
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                                    <option value="preserve_all">üîä Preserve All Tracks</option>
                                    <option value="keep_primary">üîà Keep Primary Only</option>
                                    <option value="stereo_mixdown">üéß Convert to Stereo</option>
                                    <option value="hd_plus_aac">üé≠ HD Audio + AAC Fallback</option>
                                    <option value="high_quality">üéµ High Quality (256kbps)</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1" id="audioHandlingHelp">Keeps all original audio tracks</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Subtitle Handling</label>
                                <select id="profileSubtitleHandling" 
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                                    <option value="none">‚ùå Remove All</option>
                                    <option value="preserve_all">üí¨ Preserve All Subtitles</option>
                                    <option value="keep_english">üá∫üá∏ English Only</option>
                                    <option value="burn_in">üî• Burn-in First Track</option>
                                    <option value="foreign_scan">üåç Foreign Audio Scan</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1" id="subtitleHandlingHelp">No subtitles in output</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 mt-3">
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="profileEnableFilters" class="mr-2">
                                    <span class="text-sm">Auto Filters</span>
                                </label>
                                <p class="text-xs text-gray-400 mt-1">Deinterlace, denoise, crop</p>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="profileChapterMarkers" checked class="mr-2">
                                    <span class="text-sm">Chapter Markers</span>
                                </label>
                                <p class="text-xs text-gray-400 mt-1">Preserve DVD/Blu-ray chapters</p>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="profileHwAccel" class="mr-2" onchange="checkHwAccel()">
                                    <span class="text-sm">HW Acceleration</span>
                                </label>
                                <p class="text-xs text-gray-400 mt-1" id="hwAccelHelp">Use GPU encoding</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="profileIsDefault" class="mr-2">
                            <span class="text-sm font-medium">Set as default profile (used when no specific profile assigned)</span>
                        </label>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Custom Arguments</label>
                        <input type="text" id="profileCustomArgs" 
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2"
                            placeholder="Additional HandBrakeCLI arguments">
                    </div>

                    <!-- AI Upscaling ‚Äî collapsible -->
                    <div class="border border-gray-700 rounded-lg overflow-hidden">
                        <button type="button" onclick="toggleProfileUpscaleSection()"
                            class="w-full flex items-center justify-between px-4 py-3 bg-gray-750 hover:bg-gray-700 transition-colors text-left">
                            <div class="flex items-center gap-2">
                                <span id="profileUpscaleToggleIcon" class="text-gray-400 text-xs">‚ñ∂</span>
                                <span class="text-sm font-medium">ü§ñ AI Upscaling</span>
                                <span id="profileUpscaleEnabledBadge" class="hidden text-xs bg-blue-600 text-white px-2 py-0.5 rounded-full">Enabled</span>
                            </div>
                            <span class="text-xs text-gray-500">Upscale low-res files before encoding</span>
                        </button>

                        <div id="profileUpscaleSection" class="hidden px-4 py-4 space-y-4 bg-gray-900 border-t border-gray-700">

                            <div class="flex items-start gap-3">
                                <input type="checkbox" id="profileUpscaleEnabled" class="mt-0.5 w-4 h-4 flex-shrink-0"
                                    onchange="handleProfileUpscaleToggle()">
                                <div>
                                    <label for="profileUpscaleEnabled" class="text-sm font-medium cursor-pointer">Enable AI Upscaling for this profile</label>
                                    <p class="text-xs text-gray-400 mt-0.5">Files assigned this profile will be upscaled before encoding when below the trigger threshold. Per-library scan root settings take priority over this.</p>
                                </div>
                            </div>

                            <div id="profileUpscaleFields" class="space-y-4 opacity-50 pointer-events-none">

                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Upscaler</label>
                                    <select id="profileUpscaleKey" onchange="handleProfileUpscalerKeyChange()"
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                        <option value="realesrgan">üé¨ Real-ESRGAN ‚Äî best for live action / films</option>
                                        <option value="realcugan">‚ö° Real-CUGAN ‚Äî fast, good for anime</option>
                                        <option value="waifu2x">üéå Waifu2x NCNN ‚Äî classic anime upscaler</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Model</label>
                                    <select id="profileUpscaleModel"
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                        <!-- populated by handleProfileUpscalerKeyChange() -->
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Trigger Below (height px)</label>
                                        <input type="number" id="profileUpscaleTrigger" value="720" min="240" max="2160"
                                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                        <p class="text-xs text-gray-500 mt-1">Files shorter than this are candidates</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Target Height (px)</label>
                                        <input type="number" id="profileUpscaleTarget" value="1080" min="480" max="4320"
                                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                        <p class="text-xs text-gray-500 mt-1">Desired output height</p>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Scale Factor</label>
                                    <select id="profileUpscaleFactor"
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                        <option value="2">2√ó ‚Äî doubles resolution (e.g. 480p ‚Üí 960p)</option>
                                        <option value="3">3√ó ‚Äî triples resolution (e.g. 480p ‚Üí 1440p)</option>
                                        <option value="4">4√ó ‚Äî quadruples resolution (e.g. 480p ‚Üí 1920p)</option>
                                    </select>
                                </div>

                                <div class="bg-yellow-900 border border-yellow-700 rounded px-4 py-3 text-xs text-yellow-200">
                                    ‚ö†Ô∏è <strong>Note:</strong> Profile-level upscaling applies to all libraries and watched folders using this profile. If a scan root has its own upscale settings enabled, those take priority over these profile settings.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="closeProfileModal()" 
                            class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded">
                            Cancel
                        </button>
                        <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded">
                            Save Profile
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Scan Root Modal -->
        <div id="scanRootModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-6 max-w-xl w-full">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold" id="scanRootModalTitle">Add Scan Root</h3>
                    <button onclick="closeScanRootModal()" class="text-gray-400 hover:text-white">‚úï</button>
                </div>
                
                <form id="scanRootForm" class="space-y-4">
                    <input type="hidden" id="scanRootId">
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Directory Path *</label>
                        <div class="flex gap-2">
                            <input type="text" id="scanRootPath" required
                                class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-2"
                                placeholder="C:\Media\Movies or /mnt/media/movies">
                            <button type="button" onclick="browseFolderPath()"
                                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded whitespace-nowrap">
                                üìÅ Browse
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Absolute path to scan for video files</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Library Type</label>
                        <select id="scanRootLibraryType" onchange="handleLibraryTypeChange()"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                            <option value="custom">‚öôÔ∏è Custom ‚Äî Manual configuration</option>
                            <option value="movie">üé¨ Movies ‚Äî Feature films, documentaries</option>
                            <option value="tv_show">üì∫ TV Shows ‚Äî Series, sitcoms, episodic</option>
                            <option value="anime">üéå Anime ‚Äî Japanese animation</option>
                            <option value="home_video">üé• Home Videos ‚Äî Personal recordings</option>
                            <option value="4k_content">üñ•Ô∏è 4K/UHD ‚Äî Ultra HD content</option>
                            <option value="web_content">üåê Web/YouTube ‚Äî Downloaded web videos</option>
                            <option value="archive">üì¶ Archive ‚Äî Long-term preservation</option>
                            <option value="music_video">üéµ Music Videos ‚Äî Concerts, MVs</option>
                        </select>
                        <p class="text-xs text-gray-400 mt-1">Selects optimized encoding settings for this content type</p>
                        <div id="libraryTypeRecommendation" class="hidden mt-2 p-3 bg-gray-600 rounded text-sm">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Encoding Profile *</label>
                        <select id="scanRootProfile" required 
                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                            <option value="">Loading profiles...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="scanRootRecursive" checked class="mr-2">
                            <span class="text-sm">Scan subdirectories recursively</span>
                        </label>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="scanRootEnabled" checked class="mr-2">
                            <span class="text-sm">Enabled</span>
                        </label>
                    </div>

                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="scanRootShowInStats" checked class="mr-1">
                            <div>
                                <span class="text-sm">Show in Statistics</span>
                                <p class="text-xs text-gray-400">When disabled, this root's files and paths are hidden from the Statistics tab for privacy</p>
                            </div>
                        </label>
                    </div>

                    <!-- AI Upscale Settings (collapsible) -->
                    <div class="border border-gray-700 rounded-lg overflow-hidden">
                        <button type="button" onclick="toggleUpscaleSection()"
                            class="w-full flex items-center justify-between px-4 py-3 bg-gray-750 hover:bg-gray-700 transition-colors text-left">
                            <div class="flex items-center gap-2">
                                <span id="upscaleSectionToggleIcon" class="text-gray-400 text-xs">‚ñ∂</span>
                                <span class="text-sm font-medium">ü§ñ AI Upscaling</span>
                                <span id="upscaleEnabledBadge" class="hidden text-xs bg-blue-600 text-white px-2 py-0.5 rounded">Enabled</span>
                            </div>
                            <span class="text-xs text-gray-500">Upscale low-res files before encoding</span>
                        </button>
                        <div id="upscaleSection" class="hidden px-4 py-4 space-y-4 bg-gray-900 border-t border-gray-700">

                            <!-- Enable toggle -->
                            <div class="flex items-start gap-3">
                                <input type="checkbox" id="scanRootUpscaleEnabled" class="mt-0.5 w-4 h-4"
                                    onchange="handleUpscaleToggle()">
                                <div>
                                    <label for="scanRootUpscaleEnabled" class="text-sm font-medium cursor-pointer">Enable AI Upscaling for this library</label>
                                    <p class="text-xs text-gray-400 mt-0.5">Files below the trigger threshold will be upscaled with AI before HandBrake encodes them. This is GPU-intensive and slow ‚Äî ideal for overnight batch jobs.</p>
                                </div>
                            </div>

                            <div id="upscaleSettingsFields" class="space-y-4 opacity-50 pointer-events-none">

                                <!-- Upscaler selection -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Upscaler</label>
                                    <select id="scanRootUpscaleKey" onchange="handleUpscalerKeyChange()"
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                        <option value="realesrgan">üé¨ Real-ESRGAN ‚Äî best for live action / films</option>
                                        <option value="realcugan">‚ö° Real-CUGAN ‚Äî fast, good for anime</option>
                                        <option value="waifu2x">üéå Waifu2x NCNN ‚Äî classic anime upscaler</option>
                                    </select>
                                </div>

                                <!-- Model -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Model</label>
                                    <select id="scanRootUpscaleModel"
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                        <!-- populated by handleUpscalerKeyChange() -->
                                    </select>
                                </div>

                                <!-- Trigger + Target in two columns -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Trigger Below (height px)</label>
                                        <input type="number" id="scanRootUpscaleTrigger" value="720" min="240" max="2160" step="1"
                                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                        <p class="text-xs text-gray-500 mt-1">Files shorter than this are candidates</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Target Height (px)</label>
                                        <input type="number" id="scanRootUpscaleTarget" value="1080" min="480" max="4320" step="1"
                                            class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                        <p class="text-xs text-gray-500 mt-1">Desired output height</p>
                                    </div>
                                </div>

                                <!-- Scale factor -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Scale Factor</label>
                                    <select id="scanRootUpscaleFactor"
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                        <option value="2">2√ó ‚Äî doubles resolution (480p ‚Üí 960p)</option>
                                        <option value="3">3√ó ‚Äî triples resolution (480p ‚Üí 1440p)</option>
                                        <option value="4">4√ó ‚Äî quadruples resolution (480p ‚Üí 1920p)</option>
                                    </select>
                                </div>

                                <!-- Disk space warning -->
                                <div class="bg-yellow-900 border border-yellow-700 rounded px-4 py-3 text-xs text-yellow-200">
                                    ‚ö†Ô∏è <strong>Disk space note:</strong> Upscaling extracts every frame as a PNG image before processing.
                                    A 30-minute 480p file at √ó2 requires ~20‚Äì50 GB of free temp space.
                                    Make sure your system drive has enough room.
                                </div>

                            </div><!-- /upscaleSettingsFields -->
                        </div><!-- /upscaleSection -->
                    </div><!-- /collapsible wrapper -->
                    
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="closeScanRootModal()" 
                            class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded">
                            Cancel
                        </button>
                        <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded">
                            Save Scan Root
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Folder Browser Modal -->
        <div id="folderBrowserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]">
            <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Browse Server Directories</h3>
                    <button onclick="closeFolderBrowser()" class="text-gray-400 hover:text-white">‚úï</button>
                </div>
                <div class="flex items-center gap-2 mb-4 p-2 bg-gray-900 rounded text-sm">
                    <span class="text-gray-400">Path:</span>
                    <span id="folderBrowserPath" class="text-blue-400 truncate" data-current-path="">Root</span>
                </div>
                <div id="folderBrowserList" class="flex-1 overflow-y-auto bg-gray-700 rounded p-2 mb-4 min-h-[300px] max-h-[400px]">
                    <p class="text-gray-400 p-4">Loading...</p>
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="closeFolderBrowser()"
                        class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">Cancel</button>
                    <button onclick="selectCurrentFolder()"
                        class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Select This Folder</button>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- FOLDER WATCHES TAB -->
        <!-- ============================================================ -->
        <div id="content-watches" class="tab-content hidden">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold">Folder Watches</h2>
                        <p class="text-sm text-gray-400 mt-1">Auto-queue new media files when they appear in watched folders</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="forceWatchCheck()" class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded text-sm">
                            üîç Check Now
                        </button>
                        <button onclick="showCreateWatchForm()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            Add Watch
                        </button>
                    </div>
                </div>
                
                <!-- Watcher Status -->
                <div id="watcherStatus" class="mb-4 p-3 bg-gray-700 rounded text-sm text-gray-300"></div>
                
                <div id="watchesList">
                    <p class="text-gray-400">Loading watches...</p>
                </div>
            </div>
        </div>
        
        <!-- Watch Modal -->
        <div id="watchModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-lg">
                <h3 id="watchModalTitle" class="text-xl font-bold mb-4">Add Folder Watch</h3>
                <form id="watchForm" onsubmit="saveWatch(event)">
                    <input type="hidden" id="watchId">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Folder Path *</label>
                            <div class="flex gap-2">
                                <input type="text" id="watchPath" required 
                                    class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-2"
                                    placeholder="/path/to/media/folder">
                                <button type="button" onclick="openFolderBrowser('watchPath')" 
                                    class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded">üìÅ</button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Encoding Profile *</label>
                            <select id="watchProfile" required 
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">File Extensions</label>
                            <input type="text" id="watchExtensions" 
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2"
                                value=".mkv,.mp4,.avi,.mov,.wmv,.flv,.webm,.m4v,.ts,.mpg,.mpeg">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="watchEnabled" checked class="mr-2">
                                <span class="text-sm">Enabled</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="watchRecursive" checked class="mr-2">
                                <span class="text-sm">Recursive</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="watchAutoQueue" checked class="mr-2">
                                <span class="text-sm">Auto Queue</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="closeWatchModal()" 
                            class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded">Cancel</button>
                        <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded">Save Watch</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- STATISTICS TAB -->
        <!-- ============================================================ -->
        <div id="content-statistics" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-4">
                    <div class="bg-gray-800 p-5 rounded-lg text-center">
                        <p class="text-gray-400 text-xs mb-1">Files Processed</p>
                        <p id="statTotalFiles" class="text-2xl font-bold text-blue-400">‚Äî</p>
                    </div>
                    <div class="bg-gray-800 p-5 rounded-lg text-center">
                        <p class="text-gray-400 text-xs mb-1">Original Size</p>
                        <p id="statOriginalSize" class="text-2xl font-bold text-gray-300">‚Äî</p>
                    </div>
                    <div class="bg-gray-800 p-5 rounded-lg text-center">
                        <p class="text-gray-400 text-xs mb-1">New Size</p>
                        <p id="statNewSize" class="text-2xl font-bold text-blue-300">‚Äî</p>
                    </div>
                    <div class="bg-gray-800 p-5 rounded-lg text-center">
                        <p class="text-gray-400 text-xs mb-1">Space Saved</p>
                        <p id="statSaved" class="text-2xl font-bold text-green-400">‚Äî</p>
                    </div>
                    <div class="bg-gray-800 p-5 rounded-lg text-center">
                        <p class="text-gray-400 text-xs mb-1">Avg Savings</p>
                        <p id="statAvgPct" class="text-2xl font-bold text-yellow-400">‚Äî</p>
                    </div>
                    <div class="bg-gray-800 p-5 rounded-lg text-center">
                        <p class="text-gray-400 text-xs mb-1">Avg Encode Time</p>
                        <p id="statAvgTime" class="text-2xl font-bold text-purple-400">‚Äî</p>
                    </div>
                </div>
                
                <!-- Daily Activity Chart -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Daily Activity</h3>
                        <select id="statsDays" onchange="loadStatistics()" 
                            class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                    <div id="dailyChart" class="h-48 flex items-end gap-1 overflow-x-auto">
                        <p class="text-gray-500 text-sm">Loading chart...</p>
                    </div>
                </div>
                
                <!-- Two Column: Codecs + Recent History -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Codec Breakdown -->
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-bold mb-4">Codec Breakdown</h3>
                        <div id="codecBreakdown" class="space-y-3">
                            <p class="text-gray-500 text-sm">Loading...</p>
                        </div>
                    </div>
                    
                    <!-- Recent History -->
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-bold mb-4">Recent Encodes</h3>
                        <div id="recentHistory" class="space-y-2 max-h-80 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Loading...</p>
                        </div>
                    </div>
                </div>
                
                <!-- System Health -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">System Health</h3>
                        <button onclick="loadHealth()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm transition-colors">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div id="healthStatus">
                        <p class="text-gray-500 text-sm">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-schedule" class="tab-content hidden">
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-bold mb-6">Encoding Schedule</h2>
                
                <div class="space-y-6">
                    <!-- Enable/Disable Schedule -->
                    <div class="flex items-center justify-between p-4 bg-gray-700 rounded-lg">
                        <div>
                            <h3 class="text-lg font-semibold">Enable Scheduled Encoding</h3>
                            <p class="text-sm text-gray-400">Automatically start/stop encoding based on schedule</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="scheduleEnabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <!-- Days of Week -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-3">Days of Week</label>
                        <div class="grid grid-cols-7 gap-2">
                            <button type="button" onclick="toggleDay(0)" id="day-0" class="day-button">Mon</button>
                            <button type="button" onclick="toggleDay(1)" id="day-1" class="day-button">Tue</button>
                            <button type="button" onclick="toggleDay(2)" id="day-2" class="day-button">Wed</button>
                            <button type="button" onclick="toggleDay(3)" id="day-3" class="day-button">Thu</button>
                            <button type="button" onclick="toggleDay(4)" id="day-4" class="day-button">Fri</button>
                            <button type="button" onclick="toggleDay(5)" id="day-5" class="day-button">Sat</button>
                            <button type="button" onclick="toggleDay(6)" id="day-6" class="day-button">Sun</button>
                        </div>
                    </div>
                    
                    <!-- Windows Rest Hours (Windows only) -->
                    <div id="windowsRestHoursSection" class="p-4 bg-gray-700 rounded-lg border border-blue-600/30">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold flex items-center gap-2">
                                    ü™ü Use Windows Active Hours
                                    <span id="windowsHoursAvailable" class="text-xs text-gray-400 font-normal">(detecting‚Ä¶)</span>
                                </h3>
                                <p class="text-sm text-gray-400 mt-1">
                                    Automatically schedule encoding during Windows' designated rest hours
                                    (outside your Active Hours set in Windows Update settings).
                                </p>
                                <p id="windowsHoursInfo" class="text-xs text-blue-400 mt-1 hidden"></p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer ml-4">
                                <input type="checkbox" id="useWindowsRestHours" class="sr-only peer" onchange="toggleWindowsHours()">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Time Window (hidden when Windows hours active) -->
                    <div id="manualTimeWindow">
                    <!-- Time Window -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Start Time</label>
                            <input 
                                type="time" 
                                id="startTime" 
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                                value="22:00"
                            >
                            <p class="text-sm text-gray-400 mt-1">When to start encoding</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">End Time</label>
                            <input 
                                type="time" 
                                id="endTime" 
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white"
                                value="06:00"
                            >
                            <p class="text-sm text-gray-400 mt-1">When to stop encoding</p>
                        </div>
                    </div>
                    </div> <!-- end manualTimeWindow -->
                    
                    <!-- Current Status -->
                    <div class="p-4 bg-gray-700 rounded-lg">
                        <h3 class="font-semibold mb-2">Current Status</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-400">Schedule Active:</span>
                                <span id="scheduleStatus" class="ml-2 font-medium">-</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Within Window:</span>
                                <span id="withinWindow" class="ml-2 font-medium">-</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Manual Override:</span>
                                <span id="manualOverride" class="ml-2 font-medium">-</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Next Check:</span>
                                <span id="nextCheck" class="ml-2 font-medium">Every minute</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="flex justify-end gap-3">
                        <button onclick="saveSchedule()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded font-medium">
                            Save Schedule
                        </button>
                    </div>
                    
                    <div id="scheduleMessage" class="hidden mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="content-logs" class="tab-content hidden">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">System Logs</h2>
                    <div class="flex gap-3">
                        <select id="logType" onchange="loadLogs()" 
                            class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                            <option value="app">Application</option>
                            <option value="handbrake">HandBrake</option>
                            <option value="errors">Errors</option>
                        </select>
                        <select id="logLevel" onchange="loadLogs()" 
                            class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                            <option value="ALL">All Levels</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                        <select id="logLines" onchange="loadLogs()" 
                            class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                            <option value="50">Last 50</option>
                            <option value="100" selected>Last 100</option>
                            <option value="250">Last 250</option>
                            <option value="500">Last 500</option>
                        </select>
                        <button onclick="loadLogs()" 
                            class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm">
                            üîÑ Refresh
                        </button>
                        <button onclick="clearLogs()" 
                            class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-sm">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>
                
                <!-- Log Stats -->
                <div id="logStats" class="mb-4 text-xs text-gray-400"></div>
                
                <!-- Log Output -->
                <div id="logOutput" 
                    class="bg-gray-900 rounded-lg p-4 font-mono text-xs leading-relaxed overflow-x-auto max-h-[600px] overflow-y-auto">
                    <p class="text-gray-500">Select a log type and click Refresh...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>

<style>
    .tab-button {
        padding: 1rem 0;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        color: #9ca3af;
    }
    
    .tab-button:hover {
        color: #fff;
    }
    
    .tab-button.active {
        color: #60a5fa;
        border-bottom-color: #60a5fa;
    }
    
    .day-button {
        padding: 0.75rem;
        border-radius: 0.5rem;
        background-color: #374151;
        color: #9ca3af;
        border: 2px solid transparent;
        transition: all 0.2s;
        cursor: pointer;
        font-weight: 500;
    }
    
    .day-button:hover {
        background-color: #4b5563;
    }
    
    .day-button-active {
        background-color: #3b82f6;
        color: white;
        border-color: #60a5fa;
    }
</style>
